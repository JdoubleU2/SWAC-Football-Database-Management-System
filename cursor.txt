1. Calculate Average Tackles per Game for a Player

DELIMITER //
CREATE FUNCTION AvgTackles(pPlayerID INT) RETURNS DECIMAL(5,2)
BEGIN
  DECLARE done INT DEFAULT FALSE;
  DECLARE tac INT DEFAULT 0;
  DECLARE countGames INT DEFAULT 0;
  DECLARE cur CURSOR FOR SELECT Tackles FROM playerstats WHERE PlayerID = pPlayerID;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  OPEN cur;
  read_loop: LOOP
    FETCH cur INTO tac;
    IF done THEN
      LEAVE read_loop;
    END IF;
    SET countGames = countGames + 1;
    SET tac = tac + tac; -- accumulate total
  END LOOP;
  CLOSE cur;

  IF countGames > 0 THEN
    RETURN tac/countGames;
  ELSE
    RETURN 0;
  END IF;
END//
DELIMITER ;


2.  List Upcoming Games
DELIMITER //
CREATE PROCEDURE ListUpcomingGames()
BEGIN
  DECLARE done INT DEFAULT FALSE;
  DECLARE gid INT;
  DECLARE gdate DATE;
  DECLARE gHome INT;
  DECLARE gAway INT;
  
  DECLARE cur CURSOR FOR SELECT GameID, Date, HomeTeamID, AwayTeamID FROM game WHERE Date >= CURDATE() ORDER BY Date;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  
  OPEN cur;
  read_loop: LOOP
    FETCH cur INTO gid, gdate, gHome, gAway;
    IF done THEN
      LEAVE read_loop;
    END IF;
    SELECT gid AS GameID, gdate AS Date, gHome AS HomeTeamID, gAway AS AwayTeamID;
  END LOOP;
  CLOSE cur;
END//
DELIMITER ;

3. Players With TDs Greater Than X
DELIMITER //
CREATE PROCEDURE PlayersWithHighTDs(IN minTDs INT)
BEGIN
  DECLARE done INT DEFAULT FALSE;
  DECLARE pid INT;
  DECLARE pname VARCHAR(100);
  
  DECLARE cur CURSOR FOR 
    SELECT PlayerID, Name FROM player WHERE PlayerID IN 
      (SELECT PlayerID FROM playerstats GROUP BY PlayerID HAVING SUM(TDs) > minTDs);
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
  
  OPEN cur;
  read_loop: LOOP
    FETCH cur INTO pid, pname;
    IF done THEN
      LEAVE read_loop;
    END IF;
    SELECT pid AS PlayerID, pname AS PlayerName;
  END LOOP;
  CLOSE cur;
END//
DELIMITER ;
